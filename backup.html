<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Splitting Tool - Hybrid Invoice</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #FF6A00 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 32px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 16px;
        }

        .platform-badge {
            display: inline-block;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #FF6A00 100%);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            margin-left: 10px;
        }

        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 60px 40px;
            text-align: center;
            background: linear-gradient(135deg, #f8f9ff 0%, #fff5f0 100%);
            transition: all 0.3s;
            cursor: pointer;
            margin-bottom: 30px;
        }

        .upload-area:hover {
            border-color: #764ba2;
            background: linear-gradient(135deg, #f0f2ff 0%, #ffe8df 100%);
        }

        .upload-area.dragover {
            border-color: #FF6A00;
            background: linear-gradient(135deg, #e8eaff 0%, #ffd4c4 100%);
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .upload-text {
            font-size: 18px;
            color: #333;
            margin-bottom: 10px;
        }

        .upload-hint {
            color: #999;
            font-size: 14px;
        }

        #fileInput {
            display: none;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #FF6A00 100%);
            color: white;
            padding: 15px 40px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .progress-section {
            display: none;
            margin-top: 30px;
            padding: 20px;
            background: #f5f5f5;
            border-radius: 10px;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #FF6A00 100%);
            width: 0%;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .status-text {
            color: #333;
            font-size: 14px;
            text-align: center;
        }

        .results-section {
            display: none;
            margin-top: 30px;
            padding: 30px;
            background: linear-gradient(135deg, #f8f9ff 0%, #fff5f0 100%);
            border-radius: 15px;
            border: 2px solid #667eea;
        }

        .box-group {
            margin-bottom: 30px;
            padding: 20px;
            background: white;
            border-radius: 10px;
            border-left: 5px solid #667eea;
        }

        .box-header {
            font-size: 20px;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .box-stats {
            font-size: 12px;
            color: #666;
            margin-bottom: 15px;
            padding: 8px;
            background: #f5f5f5;
            border-radius: 6px;
        }

        .box-badge {
            background: #667eea;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
        }

        .box-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .result-item {
            background: #f9f9f9;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 3px solid #4CAF50;
        }

        .order-info {
            flex: 1;
        }

        .order-id {
            font-weight: bold;
            color: #333;
            font-size: 14px;
        }

        .order-details {
            color: #666;
            font-size: 12px;
            margin-top: 3px;
        }

        .platform-tag {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
            margin-left: 8px;
        }

        .platform-tiktok {
            background: #667eea;
            color: white;
        }

        .platform-shopee {
            background: #FF6A00;
            color: white;
        }

        .download-btn {
            background: #4CAF50;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            font-size: 12px;
        }

        .download-btn:hover {
            background: #45a049;
            transform: scale(1.05);
        }

        .download-box-btn {
            background: #2196F3;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            font-size: 14px;
            width: 100%;
        }

        .download-box-btn:hover {
            background: #1976D2;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.4);
        }

        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            border-left: 4px solid #c62828;
            display: none;
        }

        .success-message {
            text-align: center;
            margin-bottom: 25px;
        }

        .success-icon {
            font-size: 48px;
            color: #4CAF50;
            margin-bottom: 10px;
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border: 2px solid #e0e0e0;
        }

        .stat-number {
            font-size: 28px;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        .platform-breakdown {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-top: 15px;
            padding: 15px;
            background: white;
            border-radius: 10px;
        }

        .platform-stat {
            text-align: center;
        }

        .platform-stat-number {
            font-size: 24px;
            font-weight: bold;
        }

        .platform-stat-label {
            font-size: 11px;
            color: #666;
            margin-top: 3px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸ“¦ Splitting Tool<span class="platform-badge">HYBRID</span></h1>
        <p class="subtitle">Upload 1 PDF berisi invoice TikTok & Shopee untuk split & grouping otomatis</p>

        <div class="upload-area" id="uploadArea">
            <div class="upload-icon">ðŸ“„</div>
            <div class="upload-text">Klik atau drag & drop PDF di sini</div>
            <div class="upload-hint">Tool akan auto-detect platform dan group per kardus</div>
            <input type="file" id="fileInput" accept=".pdf">
        </div>

        <div style="text-align: center;">
            <button class="btn" id="processBtn" disabled>ðŸš€ Proses Splitting</button>
        </div>

        <div class="progress-section" id="progressSection">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill">0%</div>
            </div>
            <div class="status-text" id="statusText">Memproses...</div>
        </div>

        <div class="error-message" id="errorMessage"></div>

        <div class="results-section" id="resultsSection">
            <div class="success-message">
                <div class="success-icon">âœ…</div>
                <h3>Split Selesai!</h3>
            </div>

            <div class="summary-stats">
                <div class="stat-card">
                    <div class="stat-number" id="totalOrders">0</div>
                    <div class="stat-label">Total Orders</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalBoxes">0</div>
                    <div class="stat-label">Total Kardus</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalItems">0</div>
                    <div class="stat-label">Total Items</div>
                </div>
            </div>

            <div class="platform-breakdown">
                <div class="platform-stat">
                    <div class="platform-stat-number" style="color: #667eea;" id="tiktokOrders">0</div>
                    <div class="platform-stat-label">ðŸ”µ TikTok Orders</div>
                </div>
                <div class="platform-stat">
                    <div class="platform-stat-number" style="color: #FF6A00;" id="shopeeOrders">0</div>
                    <div class="platform-stat-label">ðŸŸ  Shopee Orders</div>
                </div>
            </div>

            <div id="boxGroups"></div>

            <div style="text-align: center; margin-top: 25px;">
                <button class="btn" onclick="downloadAllPDF()">ðŸ“¥ Download Semua Kardus (PDF Terpisah)</button>
            </div>
        </div>
    </div>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

        const SKU_DB = {
            // A
            'ACCGS01': 1.5,    // Lume Guasha Massage Tool
            'ACSRS01': 4,    // Scalp Massager
            'ACSRS02': 1,    // Detangler Brush
            'ACN01': 1.5,      // Acne Spot Treatment
            'AMD001': 10,     // Amande Perfume 60mL
            
            // B
            'BAHB03': 12,    // Bundling Amande Body Serum Kecil
            'BBLUME': 3,     // Beauty Blender
            'BDAMUN': 14,    // Body Amande Bundle (large)
            'BDFBKL': 5,     // Flawless Base Duo Bundle - Kuning Langsat
            'BDFBSM': 5,     // Flawless Base Duo Bundle - Shea Butter
            'BDPBKL': 6,     // Body Perfect Bundle - Kuning Langsat
            'BDPBLT': 6,     // Body Perfect Bundle - Lavender Tea
            'BDPBPO': 6,     // Body Perfect Bundle - Papaya Oat
            'BDSGSM': 5,     // LUMECOLORS BUNDLING SMOOTH
            'BDSGPO': 5,     // LUMECOLORS BUNDLING SMOOTH - Putih Oriental
            'BDYOIL01': 4,   // Body Oil 150ml
            'BDYOIL02': 6,   // Body Oil 300ml
            'BDYSR01': 4,    // Body Serum 150ml
            'BDYSR02': 6,    // Body Serum 300ml
            'BRM001': 1.5,     // Browmate 4-in-1
            
            // C
            'CSHN001': 3,    // Cushion Light
            'CSHN002': 3,    // Cushion Neutral
            'CSHN003': 3,    // Cushion Sand
            'CWD000': 1.5,     // Compact Powder Fair
            'CWD001': 1.5,     // Compact Powder Light
            'CWD002': 1.5,     // Compact Powder Neutral
            'CWD003': 1.5,     // Compact Powder Sand
            
            // E
            'ECLUME2': 4,    // Eyeconic Duo Pencil
            'EDLP03': 4,     // PAKET LOOSE POWDER + EYECONIC G.TAN+ASPHALTGREY
            
            // F
            'FCRP01': 3.3,   // Face Cream Palette 1
            'FCRP02': 3.3,   // Face Cream Palette 2
            'FCRP03': 3.3,   // Face Cream Palette 3
            'FCRP05': 6,     // Face Cream Palette 1+3
            'FCRP06': 6,     // Face Cream Palette 2+3
            'FCRP07': 9,     // Face Cream Pallete 1+2+3
            'FOND01': 3,     // Foundation Sand 30ml
            'FOND02': 3,     // Foundation Light 30ml
            'FOND03': 3,     // Foundation Neutral 30ml
            
            // H
            'HAIRMSK01': 4,  // Hair Mask 150ml
            'HAIRMSK02': 6,  // Hair Mask 320ml
            'HAIRSO01': 4,   // Hair Therapy Shampoo 150ml
            'HAIRSO02': 6,   // Hair Therapy Shampoo 320ml

            // K
            'K31EC0B9': 1,   //Lipcoat Bare With Me
            'K31EF089': 1,   //Lipcoat Pumpkin Pie
            
            // L
            'LOOSE00': 3,    // Loose Powder Light
            'LOOSE01': 3,    // Loose Powder Light Neutral
            'LOOSE02': 3,    // Loose Powder Medium Neutral
            'LOOSE03': 3,    // Loose Powder Golden Tan
            'LS0001': 1,     // Velvet Creme Lipstick Nude01
            'LS0002': 1,     // Velvet Creme Lipstick Nude02
            'LTINT01': 1,    // Ultralight Liptint Stormy
            'LTINT02': 1,    // Ultralight Liptint Innocent
            'LTINT03': 1,    // Ultralight Liptint Lovely
            'LTINT04': 1,    // Ultralight Liptint All Variant
            
            // P
            'PAL000': 5,     // Palette (various)
            'PRF01': 12,      // Perfume 3-Set Eau de Parfum
            
            // S
            'SRFC01': 3,     // Nourishing Facial Cleanser 30ml
            'SRFC02': 6,     // Nourishing Facial Cleanser 100ml
            'SRET01': 2,     // Hydro Boost Essence 33.5ml
            'SRET02': 3,     // Hydro Boost Essence 80ml
            'SRBR01': 2,     // LUME Brightening Serum Concentrate 10ml
            'SRBR02': 3,     // LUME Brightening Serum Concentrate 35ml
            
            // U
            'UNIX003': 8,    // Unisex Perfume Set ONE AQUA BLUE
            };

        // Helper function to format number with decimals
        function formatScore(num) {
            // Remove trailing zeros after decimal
            return Number(num.toFixed(2)).toString();
        }

        let selectedFile = null;
        let processedOrders = [];

        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const processBtn = document.getElementById('processBtn');

        uploadArea.addEventListener('click', () => fileInput.click());

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) handleFileSelect(files[0]);
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) handleFileSelect(e.target.files[0]);
        });

        function handleFileSelect(file) {
            if (file.type !== 'application/pdf') {
                showError('Hanya file PDF yang diperbolehkan!');
                return;
            }
            selectedFile = file;
            uploadArea.querySelector('.upload-text').textContent = `âœ“ ${file.name}`;
            processBtn.disabled = false;
            hideError();
        }

        processBtn.addEventListener('click', async () => {
            if (!selectedFile) return;
            await processPDF(selectedFile);
        });

        async function processPDF(file) {
            showProgress();
            updateProgress(10, 'Membaca PDF...');

            try {
                const arrayBuffer = await file.arrayBuffer();
                
                updateProgress(30, 'Menganalisis orders dari TikTok & Shopee...');
                const orders = await splitPDFByOrders(arrayBuffer);
                
                if (orders.length === 0) {
                    throw new Error('Tidak ada order yang ditemukan dalam PDF');
                }

                updateProgress(60, 'Mengelompokkan per kardus...');
                const boxGroups = groupOrdersByBox(orders);
                
                updateProgress(90, 'Menyiapkan download...');
                processedOrders = boxGroups;
                
                updateProgress(100, 'Selesai!');
                showResults(boxGroups, orders);
                
            } catch (error) {
                console.error('Error:', error);
                showError('Error memproses PDF: ' + error.message);
                hideProgress();
            }
        }

        async function splitPDFByOrders(arrayBuffer) {
            const { PDFDocument } = PDFLib;
            const pdfDoc = await PDFDocument.load(arrayBuffer);
            const numPages = pdfDoc.getPageCount();
            
            const orders = [];
            let currentOrder = null;
            let currentPages = [];

            const loadingTask = pdfjsLib.getDocument({ data: arrayBuffer });
            const pdf = await loadingTask.promise;

            for (let i = 1; i <= numPages; i++) {
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                const text = textContent.items.map(item => item.str).join(' ');

                // Detect platform & order ID
                let platform = null;
                let orderMatch = null;

                // Try TikTok/Tokopedia pattern first
                orderMatch = text.match(/Order ID[:\s]*(\d+)/i);
                if (orderMatch) {
                    platform = 'TIKTOK';
                } else {
                    // Try Shopee pattern
                    orderMatch = text.match(/No\.Pesanan[:\s]*([A-Z0-9]+)/i);
                    if (orderMatch) {
                        platform = 'SHOPEE';
                    }
                }
                
                if (orderMatch && platform) {
                    if (currentOrder && currentPages.length > 0) {
                        const orderPdf = await PDFDocument.create();
                        for (const pageNum of currentPages) {
                            const [copiedPage] = await orderPdf.copyPages(pdfDoc, [pageNum]);
                            orderPdf.addPage(copiedPage);
                        }
                        
                        orders.push({
                            orderId: currentOrder.orderId,
                            platform: currentOrder.platform,
                            items: currentOrder.items,
                            totalScore: currentOrder.totalScore,
                            pdf: orderPdf,
                            pdfBytes: await orderPdf.save()
                        });
                    }

                    // Extract SKU & Qty
                    const items = [];
                    let totalScore = 0;
                    
                    const allWords = text.split(/\s+/);
                    const foundSkus = [];
                    
                    for (let j = 0; j < allWords.length; j++) {
                        const word = allWords[j];
                        
                        if (/^[A-Z]{2,7}(\d{0,6})?$/.test(word) && 
                            SKU_DB.hasOwnProperty(word) && 
                            !foundSkus.includes(word)) {
                            
                            foundSkus.push(word);
                            
                            let qty = 1;
                            for (let k = j + 1; k <= j + 5 && k < allWords.length; k++) {
                                const potentialQty = parseInt(allWords[k]);
                                if (!isNaN(potentialQty) && potentialQty > 0 && potentialQty <= 100) {
                                    qty = potentialQty;
                                    break;
                                }
                            }
                            
                            const volumeScore = getVolumeScore(word);
                            const itemScore = parseFloat((volumeScore * qty).toFixed(2));
                            
                            items.push({
                                sku: word,
                                qty: qty,
                                volumeScore: volumeScore,
                                itemScore: itemScore
                            });
                            
                            totalScore += itemScore;
                        }
                    }
                    
                    if (items.length === 0) {
                        items.push({
                            sku: 'UNKNOWN',
                            qty: 1,
                            volumeScore: 2,
                            itemScore: 2
                        });
                        totalScore = 2;
                    }

                    currentOrder = {
                        orderId: orderMatch[1],
                        platform: platform,
                        items: items,
                        totalScore: parseFloat(totalScore.toFixed(2))
                    };
                    currentPages = [i - 1];
                } else if (currentOrder) {
                    currentPages.push(i - 1);
                }
            }

            if (currentOrder && currentPages.length > 0) {
                const orderPdf = await PDFDocument.create();
                for (const pageNum of currentPages) {
                    const [copiedPage] = await orderPdf.copyPages(pdfDoc, [pageNum]);
                    orderPdf.addPage(copiedPage);
                }
                
                orders.push({
                    orderId: currentOrder.orderId,
                    platform: currentOrder.platform,
                    items: currentOrder.items,
                    totalScore: currentOrder.totalScore,
                    pdf: orderPdf,
                    pdfBytes: await orderPdf.save()
                });
            }

            return orders;
        }

        function getVolumeScore(sku) {
            return SKU_DB[sku] || 2;
        }

        function chooseBoxSize(totalScore) {
            if (totalScore <= 3) return { type: 'SMALL', capacity: 3, color: '#4CAF50' };
            if (totalScore <= 8) return { type: 'MEDIUM', capacity: 8, color: '#2196F3' };
            if (totalScore <= 20) return { type: 'LARGE', capacity: 20, color: '#FF9800' };
            return { type: 'OVERSIZE', capacity: 100, color: '#F44336' };
        }

        function getSkuPrefix(sku) {
            return sku.replace(/\d+$/, '');
        }

        function groupOrdersByBox(orders) {
            const boxes = {};

            orders.forEach(order => {
                const totalScore = order.totalScore;
                const boxInfo = chooseBoxSize(totalScore);
                const boxType = boxInfo.type;

                if (!boxes[boxType]) {
                    boxes[boxType] = {
                        type: boxType,
                        capacity: boxInfo.capacity,
                        color: boxInfo.color,
                        orders: []
                    };
                }

                boxes[boxType].orders.push(order);
            });

            // Sort by SKU family (cross-platform)
            for (const boxType in boxes) {
                boxes[boxType].orders.sort((a, b) => {
                    const skuA = a.items[0].sku;
                    const skuB = b.items[0].sku;
                    
                    const prefixA = getSkuPrefix(skuA);
                    const prefixB = getSkuPrefix(skuB);
                    
                    if (prefixA !== prefixB) {
                        return prefixA.localeCompare(prefixB);
                    }
                    
                    return skuA.localeCompare(skuB);
                });
            }

            return boxes;
        }

        async function downloadBoxPDF(boxType) {
            const { PDFDocument } = PDFLib;
            const boxData = processedOrders[boxType];
            
            const mergedPdf = await PDFDocument.create();
            
            for (const order of boxData.orders) {
                const orderPdf = await PDFDocument.load(order.pdfBytes);
                const copiedPages = await mergedPdf.copyPages(orderPdf, orderPdf.getPageIndices());
                copiedPages.forEach((page) => mergedPdf.addPage(page));
            }
            
            const mergedPdfBytes = await mergedPdf.save();
            const blob = new Blob([mergedPdfBytes], { type: 'application/pdf' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `HYBRID_KARDUS_${boxType}_${boxData.orders.length}orders_${Date.now()}.pdf`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        async function downloadAllPDF() {
            for (const [boxType, boxData] of Object.entries(processedOrders)) {
                await downloadBoxPDF(boxType);
                await new Promise(resolve => setTimeout(resolve, 500));
            }
        }

        async function downloadSingleOrder(boxType, orderIndex) {
            const order = processedOrders[boxType].orders[orderIndex];
            const blob = new Blob([order.pdfBytes], { type: 'application/pdf' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${order.platform}_ORDER_${order.orderId}.pdf`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function showResults(boxGroups, orders) {
            const resultsSection = document.getElementById('resultsSection');
            const boxGroupsDiv = document.getElementById('boxGroups');
            
            // Count platforms
            let tiktokCount = 0;
            let shopeeCount = 0;
            orders.forEach(order => {
                if (order.platform === 'TIKTOK') tiktokCount++;
                else if (order.platform === 'SHOPEE') shopeeCount++;
            });

            document.getElementById('totalOrders').textContent = orders.length;
            document.getElementById('totalBoxes').textContent = Object.keys(boxGroups).length;
            document.getElementById('tiktokOrders').textContent = tiktokCount;
            document.getElementById('shopeeOrders').textContent = shopeeCount;
            
            let totalItems = 0;
            Object.values(boxGroups).forEach(box => {
                box.orders.forEach(order => {
                    order.items.forEach(item => totalItems += item.qty);
                });
            });
            document.getElementById('totalItems').textContent = totalItems;

            boxGroupsDiv.innerHTML = '';

            for (const [boxType, boxData] of Object.entries(boxGroups)) {
                const boxDiv = document.createElement('div');
                boxDiv.className = 'box-group';
                boxDiv.style.borderLeftColor = boxData.color;

                // Count platform breakdown in this box
                let boxTiktok = 0;
                let boxShopee = 0;
                boxData.orders.forEach(order => {
                    if (order.platform === 'TIKTOK') boxTiktok++;
                    else if (order.platform === 'SHOPEE') boxShopee++;
                });

                let boxHtml = `
                    <div class="box-header">
                        <span>ðŸ“¦ KARDUS ${boxType}</span>
                        <span class="box-badge" style="background: ${boxData.color}">${boxData.orders.length} orders</span>
                    </div>
                    <div class="box-stats">
                        ðŸ”µ TikTok: ${boxTiktok} orders | ðŸŸ  Shopee: ${boxShopee} orders
                    </div>
                    <div class="box-actions">
                        <button class="download-box-btn" onclick="downloadBoxPDF('${boxType}')">
                            ðŸ“„ Download PDF Kardus Ini (${boxData.orders.length} orders)
                        </button>
                    </div>
                `;

                boxData.orders.forEach((order, index) => {
                    const itemsDisplay = order.items.map(item => 
                        `${item.sku} (${item.qty}x)`
                    ).join(', ');
                    
                    const itemsDetail = order.items.map(item =>
                        `${item.sku}: ${formatScore(item.volumeScore)} Ã— ${item.qty} = ${formatScore(item.itemScore)}`
                    ).join(' | ');
                    
                    const skuFamily = getSkuPrefix(order.items[0].sku);
                    const platformClass = order.platform === 'TIKTOK' ? 'platform-tiktok' : 'platform-shopee';
                    const platformIcon = order.platform === 'TIKTOK' ? 'ðŸ”µ' : 'ðŸŸ ';
                    
                    boxHtml += `
                        <div class="result-item">
                            <div class="order-info">
                                <div class="order-id">
                                    ${platformIcon} Order #${order.orderId}
                                    <span class="platform-tag ${platformClass}">${order.platform}</span>
                                    <span style="background: #e3f2fd; color: #1976d2; padding: 2px 8px; border-radius: 4px; font-size: 11px; margin-left: 8px;">${skuFamily}</span>
                                </div>
                                <div class="order-details">${itemsDisplay} â€¢ Total Score: ${formatScore(order.totalScore)}</div>
                                <div class="order-details" style="font-size: 11px; color: #999;">${itemsDetail}</div>
                            </div>
                            <button class="download-btn" onclick="downloadSingleOrder('${boxType}', ${index})">
                                ðŸ“¥ Download
                            </button>
                        </div>
                    `;
                });

                boxDiv.innerHTML = boxHtml;
                boxGroupsDiv.appendChild(boxDiv);
            }

            resultsSection.style.display = 'block';
            hideProgress();
        }

        function showProgress() {
            document.getElementById('progressSection').style.display = 'block';
            document.getElementById('resultsSection').style.display = 'none';
            processBtn.disabled = true;
        }

        function hideProgress() {
            document.getElementById('progressSection').style.display = 'none';
            processBtn.disabled = false;
        }

        function updateProgress(percent, text) {
            document.getElementById('progressFill').style.width = percent + '%';
            document.getElementById('progressFill').textContent = percent + '%';
            document.getElementById('statusText').textContent = text;
        }

        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorMessage').style.display = 'block';
        }

        function hideError() {
            document.getElementById('errorMessage').style.display = 'none';
        }
    </script>
</body>
</html>