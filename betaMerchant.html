<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Splitting Tool - Merchant Invoice</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 32px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 16px;
        }

        .platform-badge {
            display: inline-block;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            margin-left: 10px;
        }

        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 60px 40px;
            text-align: center;
            background: linear-gradient(135deg, #f8f9ff 0%, #fef5ff 100%);
            transition: all 0.3s;
            cursor: pointer;
            margin-bottom: 30px;
        }

        .upload-area:hover {
            border-color: #764ba2;
            background: linear-gradient(135deg, #f0f2ff 0%, #fce8ff 100%);
        }

        .upload-area.dragover {
            border-color: #f093fb;
            background: linear-gradient(135deg, #e8eaff 0%, #f9d4ff 100%);
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .upload-text {
            font-size: 18px;
            color: #333;
            margin-bottom: 10px;
        }

        .upload-hint {
            color: #999;
            font-size: 14px;
        }

        #fileInput {
            display: none;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            color: white;
            padding: 15px 40px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .progress-section {
            display: none;
            margin-top: 30px;
            padding: 20px;
            background: #f5f5f5;
            border-radius: 10px;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            width: 0%;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .status-text {
            color: #333;
            font-size: 14px;
            text-align: center;
        }

        .results-section {
            display: none;
            margin-top: 30px;
            padding: 30px;
            background: linear-gradient(135deg, #f8f9ff 0%, #fef5ff 100%);
            border-radius: 15px;
            border: 2px solid #667eea;
        }

        .box-group {
            margin-bottom: 30px;
            padding: 20px;
            background: white;
            border-radius: 10px;
            border-left: 5px solid #667eea;
        }

        .box-header {
            font-size: 20px;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .box-stats {
            font-size: 12px;
            color: #666;
            margin-bottom: 15px;
            padding: 8px;
            background: #f5f5f5;
            border-radius: 6px;
        }

        .box-badge {
            background: #667eea;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
        }

        .box-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .result-item {
            background: #f9f9f9;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 3px solid #4CAF50;
        }

        .order-info {
            flex: 1;
        }

        .order-id {
            font-weight: bold;
            color: #333;
            font-size: 14px;
        }

        .order-details {
            color: #666;
            font-size: 12px;
            margin-top: 3px;
        }

        .platform-tag {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
            margin-left: 8px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .download-btn {
            background: #4CAF50;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            font-size: 12px;
        }

        .download-btn:hover {
            background: #45a049;
            transform: scale(1.05);
        }

        .download-box-btn {
            background: #2196F3;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            font-size: 14px;
            width: 100%;
        }

        .download-box-btn:hover {
            background: #1976D2;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.4);
        }

        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            border-left: 4px solid #c62828;
            display: none;
        }

        .warning-message {
            background: #fff3e0;
            color: #e65100;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #ff9800;
        }

        .warning-message h4 {
            margin-bottom: 10px;
            font-size: 16px;
        }

        .warning-message ul {
            margin-left: 20px;
            font-size: 13px;
        }

        .warning-message li {
            margin-bottom: 5px;
        }

        .success-message {
            text-align: center;
            margin-bottom: 25px;
        }

        .success-icon {
            font-size: 48px;
            color: #4CAF50;
            margin-bottom: 10px;
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border: 2px solid #e0e0e0;
        }

        .stat-number {
            font-size: 28px;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üì¶ Splitting Tool<span class="platform-badge">MERCHANT</span></h1>
        <p class="subtitle">Upload 1 PDF berisi invoice Merchant untuk split & grouping otomatis per kardus</p>

        <div class="upload-area" id="uploadArea">
            <div class="upload-icon">üìÑ</div>
            <div class="upload-text">Klik atau drag & drop PDF di sini</div>
            <div class="upload-hint">Tool akan auto-detect Nomor Resi dan group per kardus</div>
            <input type="file" id="fileInput" accept=".pdf">
        </div>

        <div style="text-align: center;">
            <button class="btn" id="processBtn" disabled>üöÄ Proses Splitting</button>
        </div>

        <div class="progress-section" id="progressSection">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill">0%</div>
            </div>
            <div class="status-text" id="statusText">Memproses...</div>
        </div>

        <div class="error-message" id="errorMessage"></div>

        <div class="results-section" id="resultsSection">
            <div class="success-message">
                <div class="success-icon">‚úÖ</div>
                <h3>Split Selesai!</h3>
            </div>

            <div class="summary-stats">
                <div class="stat-card">
                    <div class="stat-number" id="totalOrders">0</div>
                    <div class="stat-label">Total Orders</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalBoxes">0</div>
                    <div class="stat-label">Total Kardus</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalItems">0</div>
                    <div class="stat-label">Total Items</div>
                </div>
            </div>

            <div id="warningsContainer"></div>
            <div id="boxGroups"></div>

            <div style="text-align: center; margin-top: 25px;">
                <button class="btn" onclick="downloadAllPDF()">üì• Download Semua Kardus (PDF Terpisah)</button>
            </div>
        </div>
    </div>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

        const SKU_DB = {
            'ACCGS01': 1.5, 'ACSRS01': 4, 'ACSRS02': 1, 'ACN01': 1.5, 'AMD001': 10,
            'BAHB03': 12, 'BBLUME': 3, 'BDAMUN': 14, 'BDFBKL': 5, 'BDFBSM': 5,
            'BDPBKL': 6, 'BDPBLT': 6, 'BDPBPO': 6, 'BDSGSM': 5, 'BDSGPO': 5,
            'BDYOIL01': 4, 'BDYOIL02': 6, 'BDYSR01': 4, 'BDYSR02': 6, 'BRM001': 1.5,
            'CSHN001': 3, 'CSHN002': 3, 'CSHN003': 3, 'CWD000': 1.5, 'CWD001': 1.5,
            'CWD002': 1.5, 'CWD003': 1.5, 'ECLUME2': 4, 'EDLP03': 4,
            'FCRP01': 3.3, 'FCRP02': 3.3, 'FCRP03': 3.3, 'FCRP05': 6, 'FCRP06': 6, 'FCRP07': 9,
            'FOND01': 3, 'FOND02': 3, 'FOND03': 3,
            'HAIRMSK01': 4, 'HAIRMSK02': 6, 'HAIRSO01': 4, 'HAIRSO02': 6,
            'K31EC0B9': 1, 'K31EF089': 1,
            'LOOSE00': 3, 'LOOSE01': 3, 'LOOSE02': 3, 'LOOSE03': 3,
            'LS0001': 1, 'LS0002': 1, 'LTINT01': 1, 'LTINT02': 1, 'LTINT03': 1, 'LTINT04': 1,
            'PAL000': 5, 'PRF01': 12,
            'SRFC01': 3, 'SRFC02': 6, 'SRET01': 2, 'SRET02': 3, 'SRBR01': 2, 'SRBR02': 3,
            'UNIX003': 8
        };

        const PRODUCT_NAME_TO_SKU = {
            // Cushion Products - ALL VARIANTS (with and without space)
            'CPÔøΩLight': 'CWD001', 'CPÔøΩFair': 'CWD000', 'CPÔøΩNeutral': 'CWD002', 'CPÔøΩSand': 'CWD003',
            'CP Light': 'CWD001', 'CP Fair': 'CWD000', 'CP Neutral': 'CWD002', 'CP Sand': 'CWD003',
            'CP-Light': 'CWD001', 'CP-Fair': 'CWD000', 'CP-Neutral': 'CWD002', 'CP-Sand': 'CWD003',
            'Cushion Light': 'CSHN001', 'Cushion Neutral': 'CSHN002', 'Cushion Sand': 'CSHN003',
            
            // Foundation Products - ALL VARIANTS
            'FDLight': 'FOND02', 'FDNeutral': 'FOND03', 'FDSand': 'FOND01',
            'FD Light': 'FOND02', 'FD Neutral': 'FOND03', 'FD Sand': 'FOND01',
            
            // Loose Powder - ALL VARIANTS
            'LPGolden Tan': 'LOOSE03', 'LPLight Neutral': 'LOOSE01', 'LPMedium Neutral': 'LOOSE02',
            'LP Golden Tan': 'LOOSE03', 'LP Light Neutral': 'LOOSE01', 'LP Medium Neutral': 'LOOSE02',
            
            // Face Care Palette Bundling
            'Bundling FC Palette 1 + 2': 'FCRP05', 
            'Bundling FC Palette 1 + 3': 'FCRP05',
            'Bundling FC Palette 2 + 3': 'FCRP06',
            'Bundling FC Palette 1 + 2 + 3': 'FCRP07',
            'Bundling FC Palette 2 +': 'FCRP06',
            'Bundling FD Botol + Eyeconic - Sand': 'BDFBKL',
            'Bundling FD Botol + Eyeconic': 'BDFBKL',
            
            // Hair Care
            'Shampoo 320 mL': 'HAIRSO02', 
            'Shampoo 150 mL': 'HAIRSO01',
            'Hair Mask 300 gr': 'HAIRMSK02', 
            'Hair Mask 150 gr': 'HAIRMSK01',
            'Hair Mask 320 mL': 'HAIRMSK02', 
            'Hair Mask 150 mL': 'HAIRMSK01',
            'Hair Serum 150 mL': 'SRBR01', 
            'Hair Serum 35 mL': 'SRBR02',
            
            // Body Care
            'Body Wash 150 mL': 'BDYSR01',
            'Body Serum 150 mL': 'SRBR01',
            
            // Parfum
            'Parfum 3set': 'PRF01', 
            'Parfum 3 set': 'PRF01',
            'Parfume AMANDE': 'AMD001', 
            'AMANDE + Shower Oil Kecil': 'BAHB03',
            'AMANDE + Shower Oil': 'BAHB03',
            'Parfum Feminine Set': 'PRF01', 
            'Parfum Unisex Set': 'UNIX003',
            'Bundling Feminine x Unisex Set': 'FCRP07',
            
            // Face Care Palette Individual
            'FCPalette 1': 'FCRP01', 
            'FCPalette 2': 'FCRP02', 
            'FCPalette 3': 'FCRP03',
            
            // Eyeconic
            'Eyeconic-Asphalt Grey': 'ECLUME2', 
            'Eyeconic Asphalt Grey': 'ECLUME2',
            'Eyeconic - Asphalt Grey': 'ECLUME2',
            
            // Beauty Tools
            'Beauty Blender': 'BBLUME',
            'Browmate': 'BBLUME',
            
            // Browlipset
            'Browlipset Nude 1': 'BRM001', 
            'Browlipset Nude 2': 'BRM001', 
            'Browlipset Nude 3': 'BRM001',
            'Browlipset Nude Nu': 'BRM001',
            
            // Liptint
            'Liptint Lovely': 'LTINT03', 
            'Liptint Innocent': 'LTINT02', 
            'Liptint Stormy': 'LTINT01',
            'Bundling 3 Liptint': 'FCRP03',
            
            // Lipstick
            'Lipstick Nude 2': 'LS0002', 
            'Lipstick Nude 1': 'LS0001',
            
            // Serum & Essence
            'Serum 35 mL': 'SRBR02', 
            'Serum 10 mL': 'SRBR01',
            'Essence 33.5 mL': 'SRET01', 
            'Essence 80 mL': 'SRET02',
            
            // Face Wash
            'Facial Wash 100 mL': 'SRFC01'
        };

        function formatScore(num) {
            return Number(num.toFixed(2)).toString();
        }

        function parseItemFromText(itemText) {
            if (!itemText || itemText.trim() === '') {
                return { items: [], unmapped: ['EMPTY_TEXT'] };
            }

            console.log(`\n=== PARSING START ===`);
            console.log(`Input: "${itemText}"`);

            // STEP 1: Try to split by "X pcs" or "X Pcs" pattern first
            let itemPatterns = itemText.match(/[^,]+?\d+\s*(?:pcs|Pcs)(?=\s*,|$)/gi);
            
            let items = [];
            if (itemPatterns && itemPatterns.length > 0) {
                // Found "X pcs" patterns
                items = itemPatterns.map(s => s.trim());
                console.log(`Found ${items.length} items with "X pcs" pattern:`, items);
            } else {
                // STEP 2: No "X pcs" found, check if there's a quantity at the end
                const endQtyMatch = itemText.match(/(.+?)\s*(\d+)\s*(?:pcs|Pcs)\s*$/i);
                
                if (endQtyMatch) {
                    // Format: "Product A, Product B, Product C 3 pcs"
                    const productsText = endQtyMatch[1];
                    const qty = endQtyMatch[2];
                    
                    console.log(`Format detected: Multiple products with shared qty ${qty}`);
                    console.log(`Products text: "${productsText}"`);
                    
                    // Split by comma to get individual products
                    const productList = productsText.split(',').map(s => s.trim()).filter(s => s.length > 0);
                    
                    // Add quantity to each product
                    items = productList.map(prod => `${prod} ${qty} pcs`);
                    console.log(`Expanded to:`, items);
                } else {
                    // STEP 3: Fallback - split by comma, assume qty = 1
                    items = itemText.split(',').map(s => s.trim()).filter(s => s.length > 0);
                    console.log(`Fallback: Split by comma, ${items.length} items:`, items);
                }
            }

            const parsedItems = [];
            const unmappedProducts = [];

            for (let itemStr of items) {
                console.log(`\n  Processing: "${itemStr}"`);
                
                // Extract quantity (last number before "pcs/Pcs")
                const qtyMatch = itemStr.match(/(\d+)\s*(?:pcs|Pcs)$/i);
                const qty = qtyMatch ? parseInt(qtyMatch[1]) : 1;
                
                // Remove quantity part to get product name
                let productName = itemStr.replace(/\d+\s*(?:pcs|Pcs)$/i, '').trim();
                
                // Normalize spaces: Remove space between capital letters (CP Light -> CPLight, FD Neutral -> FDNeutral)
                // This fixes PDF extraction inconsistencies
                productName = productName
                    .replace(/ÔøΩ/g, '')           // hapus karakter corrupted
                    .replace(/[‚Äì‚Äî]/g, '-')       // normalisasi dash
                    .replace(/\s+/g, ' ')        // normalisasi spasi
                    .trim();
                productName = productName.replace(/\s+/g, ' ').trim();
                productName = productName.replace(/([A-Z]{2})\s+([A-Z][a-z]+)/g, '$1$2'); // "CP Light" -> "CPLight"
                productName = productName.replace(/([A-Z]{2})\s+([A-Z]{2})/g, '$1$2'); // "LP Golden" -> "LPGolden"
                
                console.log(`    ‚Üí Product: "${productName}", Qty: ${qty}`);
                
                let sku = null;
                let volumeScore = 2;
                let matchedName = null;
                
                // Try exact match first (case insensitive)
                for (let [name, skuCode] of Object.entries(PRODUCT_NAME_TO_SKU)) {
                    if (productName.toLowerCase() === name.toLowerCase()) {
                        sku = skuCode;
                        volumeScore = SKU_DB[skuCode] || 2;
                        matchedName = name;
                        console.log(`    ‚úì EXACT MATCH: ${name} ‚Üí ${sku}`);
                        break;
                    }
                }
                
                // Try partial match if no exact match
                if (!sku) {
                    for (let [name, skuCode] of Object.entries(PRODUCT_NAME_TO_SKU)) {
                        if (productName.toLowerCase().includes(name.toLowerCase()) || 
                            name.toLowerCase().includes(productName.toLowerCase())) {
                            sku = skuCode;
                            volumeScore = SKU_DB[skuCode] || 2;
                            matchedName = name;
                            console.log(`    ‚âà PARTIAL MATCH: ${name} ‚Üí ${sku}`);
                            break;
                        }
                    }
                }
                
                if (!sku) {
                    sku = 'UNKNOWN_' + productName.replace(/\s+/g, '_').substring(0, 15);
                    unmappedProducts.push(productName);
                    console.log(`    ‚úó NOT MAPPED: "${productName}"`);
                }
                
                parsedItems.push({
                    originalText: itemStr,
                    productName: productName,
                    sku: sku,
                    qty: qty,
                    volumeScore: volumeScore,
                    itemScore: parseFloat((volumeScore * qty).toFixed(2))
                });
            }
            
            console.log(`=== PARSING END ===\n`);
            return { items: parsedItems, unmapped: unmappedProducts };
        }

        let selectedFile = null;
        let processedOrders = [];
        let validationWarnings = [];

        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const processBtn = document.getElementById('processBtn');

        uploadArea.addEventListener('click', () => fileInput.click());
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) handleFileSelect(files[0]);
        });
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) handleFileSelect(e.target.files[0]);
        });

        function handleFileSelect(file) {
            if (file.type !== 'application/pdf') {
                showError('Hanya file PDF yang diperbolehkan!');
                return;
            }
            selectedFile = file;
            uploadArea.querySelector('.upload-text').textContent = `‚úì ${file.name}`;
            processBtn.disabled = false;
            hideError();
        }

        processBtn.addEventListener('click', async () => {
            if (!selectedFile) return;
            await processPDF(selectedFile);
        });

        async function processPDF(file) {
            showProgress();
            updateProgress(10, 'Membaca PDF...');
            validationWarnings = [];

            try {
                const arrayBuffer = await file.arrayBuffer();
                
                updateProgress(30, 'Menganalisis orders dari Merchant...');
                const orders = await splitPDFByOrders(arrayBuffer);
                
                if (orders.length === 0) {
                    throw new Error('Tidak ada order yang ditemukan dalam PDF');
                }

                updateProgress(60, 'Mengelompokkan per kardus...');
                const boxGroups = groupOrdersByBox(orders);
                
                updateProgress(90, 'Menyiapkan download...');
                processedOrders = boxGroups;
                
                updateProgress(100, 'Selesai!');
                showResults(boxGroups, orders);
                
            } catch (error) {
                console.error('Error:', error);
                showError('Error memproses PDF: ' + error.message);
                hideProgress();
            }
        }

        async function splitPDFByOrders(arrayBuffer) {
            const { PDFDocument } = PDFLib;
            const pdfDoc = await PDFDocument.load(arrayBuffer);
            const numPages = pdfDoc.getPageCount();
            
            const orders = [];
            let currentOrder = null;
            let currentPages = [];

            const loadingTask = pdfjsLib.getDocument({ data: arrayBuffer });
            const pdf = await loadingTask.promise;

            for (let i = 1; i <= numPages; i++) {
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                
                // Extract text items with positions
                const textItems = textContent.items.map(item => ({
                    text: item.str,
                    x: item.transform[4],
                    y: item.transform[5]
                }));
                
                // Sort by Y position (top to bottom), then X (left to right)
                textItems.sort((a, b) => {
                    if (Math.abs(b.y - a.y) > 5) return b.y - a.y;
                    return a.x - b.x;
                });
                
                // Build text with proper line breaks
                let text = '';
                let currentLine = '';
                let lastY = textItems.length > 0 ? textItems[0].y : 0;
                
                for (const item of textItems) {
                    if (Math.abs(item.y - lastY) > 5) {
                        text += currentLine + '\n';
                        currentLine = item.text;
                    } else {
                        currentLine += ' ' + item.text;
                    }
                    lastY = item.y;
                }
                text += currentLine;
                
                if (i === 1) {
                    console.log('=== RAW TEXT FROM PAGE 1 ===');
                    console.log(text.substring(0, 1000));
                }

                // Look for Nomor Resi pattern
                let resiMatch = text.match(/Nomor\s+Resi\s+(\d{13,16})/i);
                
                if (!resiMatch) {
                    const allNumbers = text.match(/\d{13,16}/g);
                    if (allNumbers && allNumbers.length > 0) {
                        resiMatch = [null, allNumbers[0]];
                    }
                }
                
                if (resiMatch) {
                    if (currentOrder && currentPages.length > 0) {
                        const orderPdf = await PDFDocument.create();
                        for (const pageNum of currentPages) {
                            const [copiedPage] = await orderPdf.copyPages(pdfDoc, [pageNum]);
                            orderPdf.addPage(copiedPage);
                        }
                        
                        orders.push({
                            orderId: currentOrder.orderId,
                            recipientName: currentOrder.recipientName,
                            items: currentOrder.items,
                            totalScore: currentOrder.totalScore,
                            unmappedProducts: currentOrder.unmappedProducts,
                            pdf: orderPdf,
                            pdfBytes: await orderPdf.save()
                        });
                    }

                    const orderId = resiMatch[1];
                    
                    // Extract recipient name
                    const nameMatch = text.match(/Kepada:\s*\n?\s*([A-Za-z\s\.]+?)(?=\n|\d|$)/i);
                    const recipientName = nameMatch ? nameMatch[1].trim().split(/\s+/).slice(0, 3).join(' ') : 'Unknown';
                    
                    // Extract ISI PAKET - improved pattern matching
                    let itemsText = '';
                    
                    // Try pattern 1: ISI PAKET on same line
                    let itemsMatch = text.match(/ISI\s+PAKET\s+(.+?)(?=\n|INSTRUKSI|Order\s+ID)/i);
                    
                    // Try pattern 2: ISI PAKET then content on next line(s)
                    if (!itemsMatch || itemsMatch[1].trim().length < 5) {
                        itemsMatch = text.match(/ISI\s+PAKET\s*\n\s*(.+?)(?=\n\s*INSTRUKSI|$)/i);
                    }
                    
                    if (itemsMatch) {
                        itemsText = itemsMatch[1].trim();
                    }
                    
                    console.log(`\n=== ORDER ${orderId} ===`);
                    console.log(`ISI PAKET extracted: "${itemsText}"`);
                    
                    const parseResult = parseItemFromText(itemsText);
                    const items = parseResult.items;
                    const unmappedProducts = parseResult.unmapped;
                    
                    if (items.length === 0) {
                        items.push({
                            originalText: 'UNKNOWN',
                            productName: 'UNKNOWN',
                            sku: 'UNKNOWN',
                            qty: 1,
                            volumeScore: 2,
                            itemScore: 2
                        });
                        unmappedProducts.push('EMPTY_ITEM_LIST');
                    }
                    
                    const totalScore = parseFloat(items.reduce((sum, item) => sum + item.itemScore, 0).toFixed(2));

                    if (unmappedProducts.length > 0) {
                        validationWarnings.push({
                            orderId: orderId,
                            recipientName: recipientName,
                            issues: [`Produk tidak dikenali: ${unmappedProducts.join(', ')}`]
                        });
                    }

                    currentOrder = {
                        orderId: orderId,
                        recipientName: recipientName,
                        items: items,
                        totalScore: totalScore,
                        unmappedProducts: unmappedProducts
                    };
                    currentPages = [i - 1];
                } else if (currentOrder) {
                    currentPages.push(i - 1);
                }
            }

            if (currentOrder && currentPages.length > 0) {
                const orderPdf = await PDFDocument.create();
                for (const pageNum of currentPages) {
                    const [copiedPage] = await orderPdf.copyPages(pdfDoc, [pageNum]);
                    orderPdf.addPage(copiedPage);
                }
                
                orders.push({
                    orderId: currentOrder.orderId,
                    recipientName: currentOrder.recipientName,
                    items: currentOrder.items,
                    totalScore: currentOrder.totalScore,
                    unmappedProducts: currentOrder.unmappedProducts,
                    pdf: orderPdf,
                    pdfBytes: await orderPdf.save()
                });
            }

            return orders;
        }

        function chooseBoxSize(totalScore) {
            if (totalScore <= 3) return { type: 'SMALL', capacity: 3, color: '#4CAF50' };
            if (totalScore <= 8) return { type: 'MEDIUM', capacity: 8, color: '#2196F3' };
            if (totalScore <= 20) return { type: 'LARGE', capacity: 20, color: '#FF9800' };
            return { type: 'OVERSIZE', capacity: 100, color: '#F44336' };
        }

        function getSkuPrefix(sku) {
            return sku.replace(/\d+$/, '');
        }

        function groupOrdersByBox(orders) {
            const boxes = {};

            orders.forEach(order => {
                const totalScore = order.totalScore;
                const boxInfo = chooseBoxSize(totalScore);
                const boxType = boxInfo.type;

                if (!boxes[boxType]) {
                    boxes[boxType] = {
                        type: boxType,
                        capacity: boxInfo.capacity,
                        color: boxInfo.color,
                        orders: []
                    };
                }

                boxes[boxType].orders.push(order);
            });

            for (const boxType in boxes) {
                boxes[boxType].orders.sort((a, b) => {
                    const skuA = a.items[0].sku;
                    const skuB = b.items[0].sku;
                    
                    const prefixA = getSkuPrefix(skuA);
                    const prefixB = getSkuPrefix(skuB);
                    
                    if (prefixA !== prefixB) {
                        return prefixA.localeCompare(prefixB);
                    }
                    
                    return skuA.localeCompare(skuB);
                });
            }

            return boxes;
        }

        async function downloadBoxPDF(boxType) {
            const { PDFDocument } = PDFLib;
            const boxData = processedOrders[boxType];
            
            const mergedPdf = await PDFDocument.create();
            
            for (const order of boxData.orders) {
                const orderPdf = await PDFDocument.load(order.pdfBytes);
                const copiedPages = await mergedPdf.copyPages(orderPdf, orderPdf.getPageIndices());
                copiedPages.forEach((page) => mergedPdf.addPage(page));
            }
            
            const mergedPdfBytes = await mergedPdf.save();
            const blob = new Blob([mergedPdfBytes], { type: 'application/pdf' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `MERCHANT_KARDUS_${boxType}_${boxData.orders.length}orders_${Date.now()}.pdf`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        async function downloadAllPDF() {
            for (const [boxType, boxData] of Object.entries(processedOrders)) {
                await downloadBoxPDF(boxType);
                await new Promise(resolve => setTimeout(resolve, 500));
            }
        }

        async function downloadSingleOrder(boxType, orderIndex) {
            const order = processedOrders[boxType].orders[orderIndex];
            const blob = new Blob([order.pdfBytes], { type: 'application/pdf' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `MERCHANT_ORDER_${order.orderId}.pdf`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function showResults(boxGroups, orders) {
            const resultsSection = document.getElementById('resultsSection');
            const boxGroupsDiv = document.getElementById('boxGroups');
            const warningsContainer = document.getElementById('warningsContainer');

            document.getElementById('totalOrders').textContent = orders.length;
            document.getElementById('totalBoxes').textContent = Object.keys(boxGroups).length;
            
            let totalItems = 0;
            Object.values(boxGroups).forEach(box => {
                box.orders.forEach(order => {
                    order.items.forEach(item => totalItems += item.qty);
                });
            });
            document.getElementById('totalItems').textContent = totalItems;

            if (validationWarnings.length > 0) {
                let warningHtml = `
                    <div class="warning-message">
                        <h4>‚ö†Ô∏è ${validationWarnings.length} order(s) perlu review manual:</h4>
                        <ul>
                `;
                validationWarnings.forEach(w => {
                    warningHtml += `<li><strong>Resi ${w.orderId}</strong> (${w.recipientName}): ${w.issues.join(', ')}</li>`;
                });
                warningHtml += `</ul></div>`;
                warningsContainer.innerHTML = warningHtml;
            } else {
                warningsContainer.innerHTML = '';
            }

            boxGroupsDiv.innerHTML = '';

            for (const [boxType, boxData] of Object.entries(boxGroups)) {
                const boxDiv = document.createElement('div');
                boxDiv.className = 'box-group';
                boxDiv.style.borderLeftColor = boxData.color;

                let boxHtml = `
                    <div class="box-header">
                        <span>üì¶ KARDUS ${boxType}</span>
                        <span class="box-badge" style="background: ${boxData.color}">${boxData.orders.length} orders</span>
                    </div>
                    <div class="box-stats">
                        üìä Capacity: ${boxData.capacity} | Orders: ${boxData.orders.length}
                    </div>
                    <div class="box-actions">
                        <button class="download-box-btn" onclick="downloadBoxPDF('${boxType}')">
                            üìÑ Download PDF Kardus Ini (${boxData.orders.length} orders)
                        </button>
                    </div>
                `;

                boxData.orders.forEach((order, index) => {
                    const itemsDisplay = order.items.map(item => {
                        const displayName = item.sku.startsWith('UNKNOWN_') 
                            ? item.productName 
                            : item.productName;
                        return `${displayName} (${item.qty}x)`;
                    }).join(', ');
                    
                    const itemsDetail = order.items.map(item => {
                        const displaySku = item.sku.startsWith('UNKNOWN_') 
                            ? '‚ùì' + item.productName.substring(0, 15)
                            : item.sku;
                        return `${displaySku}: ${formatScore(item.volumeScore)} √ó ${item.qty} = ${formatScore(item.itemScore)}`;
                    }).join(' | ');
                    
                    const skuFamily = getSkuPrefix(order.items[0].sku);
                    const hasWarning = order.unmappedProducts && order.unmappedProducts.length > 0;
                    
                    boxHtml += `
                        <div class="result-item" style="${hasWarning ? 'border-left-color: #ff9800;' : ''}">
                            <div class="order-info">
                                <div class="order-id">
                                    ü™™ Resi #${order.orderId}
                                    <span class="platform-tag">MERCHANT</span>
                                    <span style="background: #e3f2fd; color: #1976d2; padding: 2px 8px; border-radius: 4px; font-size: 11px; margin-left: 8px;">${skuFamily}</span>
                                    ${hasWarning ? '<span style="background: #fff3e0; color: #e65100; padding: 2px 8px; border-radius: 4px; font-size: 11px; margin-left: 8px;">‚ö†Ô∏è REVIEW</span>' : ''}
                                </div>
                                <div class="order-details">${order.recipientName} ‚Ä¢ ${itemsDisplay} ‚Ä¢ Total Score: ${formatScore(order.totalScore)}</div>
                                <div class="order-details" style="font-size: 11px; color: #999;">${itemsDetail}</div>
                            </div>
                            <button class="download-btn" onclick="downloadSingleOrder('${boxType}', ${index})">
                                üì• Download
                            </button>
                        </div>
                    `;
                });

                boxDiv.innerHTML = boxHtml;
                boxGroupsDiv.appendChild(boxDiv);
            }

            resultsSection.style.display = 'block';
            hideProgress();
        }

        function showProgress() {
            document.getElementById('progressSection').style.display = 'block';
            document.getElementById('resultsSection').style.display = 'none';
            processBtn.disabled = true;
        }

        function hideProgress() {
            document.getElementById('progressSection').style.display = 'none';
            processBtn.disabled = false;
        }

        function updateProgress(percent, text) {
            document.getElementById('progressFill').style.width = percent + '%';
            document.getElementById('progressFill').textContent = percent + '%';
            document.getElementById('statusText').textContent = text;
        }

        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorMessage').style.display = 'block';
        }

        function hideError() {
            document.getElementById('errorMessage').style.display = 'none';
        }
    </script>
</body>
</html>