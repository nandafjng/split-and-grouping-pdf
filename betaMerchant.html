<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Packing Tool - Merchant Orders</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 50%, #7e22ce 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 32px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 16px;
        }

        .platform-badge {
            display: inline-block;
            background: linear-gradient(135deg, #1e3c72 0%, #7e22ce 100%);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            margin-left: 10px;
        }

        .upload-area {
            border: 3px dashed #1e3c72;
            border-radius: 15px;
            padding: 60px 40px;
            text-align: center;
            background: #f0f4ff;
            transition: all 0.3s;
            cursor: pointer;
            margin-bottom: 30px;
        }

        .upload-area:hover {
            border-color: #7e22ce;
            background: #e8f0ff;
        }

        .upload-area.dragover {
            border-color: #7e22ce;
            background: #dce8ff;
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .upload-text {
            font-size: 18px;
            color: #333;
            margin-bottom: 10px;
        }

        .upload-hint {
            color: #999;
            font-size: 14px;
        }

        #fileInput {
            display: none;
        }

        .btn {
            background: linear-gradient(135deg, #1e3c72 0%, #7e22ce 100%);
            color: white;
            padding: 15px 40px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(30, 60, 114, 0.4);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(30, 60, 114, 0.6);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .progress-section {
            display: none;
            margin-top: 30px;
            padding: 20px;
            background: #f5f5f5;
            border-radius: 10px;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #1e3c72 0%, #7e22ce 100%);
            width: 0%;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .status-text {
            color: #333;
            font-size: 14px;
            text-align: center;
        }

        .results-section {
            display: none;
            margin-top: 30px;
            padding: 30px;
            background: #f0f4ff;
            border-radius: 15px;
            border: 2px solid #1e3c72;
        }

        .box-group {
            margin-bottom: 30px;
            padding: 20px;
            background: white;
            border-radius: 10px;
            border-left: 5px solid #1e3c72;
        }

        .box-header {
            font-size: 20px;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .box-badge {
            background: #1e3c72;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
        }

        .box-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .result-item {
            background: #f9f9f9;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 3px solid #4CAF50;
        }

        .result-item.unknown {
            border-left: 3px solid #FF9800;
            background: #fff3e0;
        }

        .order-info {
            flex: 1;
        }

        .order-id {
            font-weight: bold;
            color: #333;
            font-size: 14px;
        }

        .order-details {
            color: #666;
            font-size: 12px;
            margin-top: 3px;
        }

        .platform-tag {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
            background: #1e3c72;
            color: white;
            margin-left: 8px;
        }

        .unknown-badge {
            background: #FF9800;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
            margin-left: 8px;
        }

        .download-btn {
            background: #4CAF50;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            font-size: 12px;
        }

        .download-btn:hover {
            background: #45a049;
            transform: scale(1.05);
        }

        .download-box-btn {
            background: #2196F3;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            font-size: 14px;
            width: 100%;
        }

        .download-box-btn:hover {
            background: #1976D2;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.4);
        }

        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            border-left: 4px solid #c62828;
            display: none;
        }

        .warning-message {
            background: #fff3e0;
            color: #ef6c00;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #FF9800;
            display: none;
        }

        .success-message {
            text-align: center;
            margin-bottom: 25px;
        }

        .success-icon {
            font-size: 48px;
            color: #4CAF50;
            margin-bottom: 10px;
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border: 2px solid #e0e0e0;
        }

        .stat-number {
            font-size: 28px;
            font-weight: bold;
            color: #1e3c72;
        }

        .stat-number.warning {
            color: #FF9800;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üì¶ Packing Tool<span class="platform-badge">MERCHANT</span></h1>
        <p class="subtitle">Upload invoice PDF dari Merchant (Web Orders) untuk split & grouping otomatis</p>

        <div class="upload-area" id="uploadArea">
            <div class="upload-icon">üìÑ</div>
            <div class="upload-text">Klik atau drag & drop PDF di sini</div>
            <div class="upload-hint">Invoice akan dipisah per order dan digrouping per kardus</div>
            <input type="file" id="fileInput" accept=".pdf">
        </div>

        <div style="text-align: center;">
            <button class="btn" id="processBtn" disabled>üöÄ Proses Packing</button>
        </div>

        <div class="progress-section" id="progressSection">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill">0%</div>
            </div>
            <div class="status-text" id="statusText">Memproses...</div>
        </div>

        <div class="error-message" id="errorMessage"></div>

        <div class="results-section" id="resultsSection">
            <div class="success-message">
                <div class="success-icon">‚úÖ</div>
                <h3>Packing Selesai!</h3>
            </div>

            <div class="warning-message" id="warningMessage"></div>

            <div class="summary-stats">
                <div class="stat-card">
                    <div class="stat-number" id="totalOrders">0</div>
                    <div class="stat-label">Total Orders</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalBoxes">0</div>
                    <div class="stat-label">Total Kardus</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalItems">0</div>
                    <div class="stat-label">Total Items</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number warning" id="unknownProducts">0</div>
                    <div class="stat-label">Unknown Products</div>
                </div>
            </div>

            <div id="boxGroups"></div>

            <div style="text-align: center; margin-top: 25px;">
                <button class="btn" onclick="downloadAllPDF()">üì• Download Semua Kardus (PDF Terpisah)</button>
            </div>
        </div>
    </div>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

        // ===========================================
        // MERCHANT PRODUCT MAPPING
        // ===========================================
        const MERCHANT_PRODUCT_MAP = {
            // Browlipset
            'Browlipset Nude 1': 'BLS001',
            'Browlipset Nude 2': 'BLS002',
            
            // Cushion
            'Cushion Light': 'CSHN001',
            'Cushion Neutral': 'CSHN002',
            'Cushion Sand': 'CSHN003',
            
            // Compact Powder (abbreviated)
            'CPFair': 'CWD000',
            'CPLight': 'CWD001',
            'CPNeutral': 'CWD002',
            
            // Essence
            'Essence 33.5 mL': 'SRET01',
            'Essence 80 mL': 'SRET02',

            // Liptint
            'Liptint Innocent': 'LTINT02',
            'Liptint Lovely': 'LTINT03',
            'Liptint Stormy': 'LTINT01',
            'Bundling 3 Liptint': 'LTINT04',
            
            // Foundation
            'FDNeutral': 'FOND03',
            'FDLight': 'FOND02',
            'FDSand': 'FOND01',
            
            // Palette
            'FC Palette 1': 'FCRP01',
            'FC Palette 3': 'FCRP03',
            
            // Perfume
            'Parfum 3set': 'PRF01',
            'Parfume AMANDE': 'AMD001',  // Typo in invoice
            'Parfum AMANDE': 'AMD001',
            'Parfum Unisex Set': 'UNIX003',
            "Parfum Feminine Set": 'PRF01',
            'Essence 33.5 mL': 'SRET01',
            'Hair Mask 300 gr': 'HAIRMSK02',
            
            // Body care
            'Body Serum 150 mL': 'BDYSR01',
            'Body Serum 300 mL': 'BDYSR02',
            'Shampoo 150 mL': 'HAIRSO01',
            'Shampoo 320 mL': 'HAIRSO02',
            'Body Wash 150 mL': 'BDYOIL01',
            'Body Wash 300 mL': 'BDYOIL02',
        };

        const MERCHANT_VOLUME_SCORES = {
            'BLS001': 10,
            'BLS002': 10,
            'BDYWASH150': 4,
        };

        // Volume score database (inherit from main SKU_DB)
        const SKU_DB = {
            // A
            'ACCGS01': 1.5,    // Lume Guasha Massage Tool
            'ACSRS01': 4,      // Scalp Massager
            'ACSRS02': 1,      // Detangler Brush
            'ACN01': 1.5,      // Acne Spot Treatment
            'AMD001': 10,      // Amande Perfume 60mL
            
            // B
            'BAHB03': 12,      // Bundling Amande Body Serum Kecil
            'BBLUME': 3,       // Beauty Blender
            'BDAMUN': 14,      // Body Amande Bundle (large)
            'BDFBKL': 5,       // Flawless Base Duo Bundle - Kuning Langsat
            'BDFBSM': 5,       // Flawless Base Duo Bundle - Shea Butter
            'BDPBKL': 6,       // Body Perfect Bundle - Kuning Langsat
            'BDPBLT': 6,       // Body Perfect Bundle - Lavender Tea
            'BDPBPO': 6,       // Body Perfect Bundle - Papaya Oat
            'BDSGSM': 5,       // LUMECOLORS BUNDLING SMOOTH
            'BDSGPO': 5,       // LUMECOLORS BUNDLING SMOOTH - Putih Oriental
            'BDYOIL01': 4,     // Body Oil 150ml
            'BDYOIL02': 6,     // Body Oil 300ml
            'BDYSR01': 4,      // Body Serum 150ml
            'BDYSR02': 6,      // Body Serum 300ml
            'BRM001': 1.5,     // Browmate 4-in-1
            
            // C
            'CSHN001': 3,      // Cushion Light
            'CSHN002': 3,      // Cushion Neutral
            'CSHN003': 3,      // Cushion Sand
            'CWD000': 1.5,     // Compact Powder Fair
            'CWD001': 1.5,     // Compact Powder Light
            'CWD002': 1.5,     // Compact Powder Neutral
            'CWD003': 1.5,     // Compact Powder Sand
            
            // E
            'ECLUME2': 4,      // Eyeconic Duo Pencil
            'EDLP03': 4,       // PAKET LOOSE POWDER + EYECONIC G.TAN+ASPHALTGREY
            
            // F
            'FCRP01': 3.3,     // Face Cream Palette 1
            'FCRP02': 3.3,     // Face Cream Palette 2
            'FCRP03': 3.3,     // Face Cream Palette 3
            'FCRP05': 6,       // Face Cream Palette 1+3
            'FCRP06': 6,       // Face Cream Palette 2+3
            'FCRP07': 9,       // Face Cream Pallete 1+2+3
            'FOND01': 3,       // Foundation Sand 30ml
            'FOND02': 3,       // Foundation Light 30ml
            'FOND03': 3,       // Foundation Neutral 30ml
            
            // H
            'HAIRMSK01': 4,    // Hair Mask 150ml
            'HAIRMSK02': 6,    // Hair Mask 320ml
            'HAIRSO01': 4,     // Hair Therapy Shampoo 150ml
            'HAIRSO02': 6,     // Hair Therapy Shampoo 320ml

            // K
            'K31EC0B9': 1,     // Lipcoat Bare With Me
            'K31EF089': 1,     // Lipcoat Pumpkin Pie
            
            // L
            'LOOSE00': 3,      // Loose Powder Light
            'LOOSE01': 3,      // Loose Powder Light Neutral
            'LOOSE02': 3,      // Loose Powder Medium Neutral
            'LOOSE03': 3,      // Loose Powder Golden Tan
            'LS0001': 1,       // Velvet Creme Lipstick Nude01
            'LS0002': 1,       // Velvet Creme Lipstick Nude02
            'LTINT01': 1,      // Ultralight Liptint Stormy
            'LTINT02': 1,      // Ultralight Liptint Innocent
            'LTINT03': 1,      // Ultralight Liptint Lovely
            'LTINT04': 1,      // Ultralight Liptint All Variant
            
            // P
            'PAL000': 5,       // Palette (various)
            'PRF01': 12,       // Perfume 3-Set Eau de Parfum
            
            // S
            'SRFC01': 3,       // Nourishing Facial Cleanser 30ml
            'SRFC02': 6,       // Nourishing Facial Cleanser 100ml
            'SRET01': 2,       // Hydro Boost Essence 33.5ml
            'SRET02': 3,       // Hydro Boost Essence 80ml
            'SRBR01': 2,       // LUME Brightening Serum Concentrate 10ml
            'SRBR02': 3,       // LUME Brightening Serum Concentrate 35ml
            
            // U
            'UNIX003': 8,      // Unisex Perfume Set ONE AQUA BLUE
        };

        let selectedFile = null;
        let processedOrders = [];
        let unknownProductsList = [];

        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const processBtn = document.getElementById('processBtn');

        uploadArea.addEventListener('click', () => fileInput.click());

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) handleFileSelect(files[0]);
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) handleFileSelect(e.target.files[0]);
        });

        function handleFileSelect(file) {
            if (file.type !== 'application/pdf') {
                showError('Hanya file PDF yang diperbolehkan!');
                return;
            }
            selectedFile = file;
            uploadArea.querySelector('.upload-text').textContent = `‚úì ${file.name}`;
            processBtn.disabled = false;
            hideError();
        }

        processBtn.addEventListener('click', async () => {
            if (!selectedFile) return;
            await processPDF(selectedFile);
        });

        function normalizeProductName(name) {
            return name
                .normalize('NFKD')
                .replace(/[\u2000-\u206F\u2E00-\u2E7F]/g, '')  // buang invisible Unicode (ZWSP, NBSP, dsb)
                .replace(/[^\w\s]/g, '')                       // buang simbol aneh
                .replace(/\s+/g, '')                           // hapus semua spasi (termasuk NBSP hasil replace)
                .toLowerCase();
        }

        function getSKUFromProduct(productName) {
            const normalized = normalizeProductName(productName);
            
            // Try exact match
            for (const [key, sku] of Object.entries(MERCHANT_PRODUCT_MAP)) {
                if (normalizeProductName(key) === normalized) {
                    return sku;
                }
            }
            
            // Try partial match (for variations)
            for (const [key, sku] of Object.entries(MERCHANT_PRODUCT_MAP)) {
                const keyNorm = normalizeProductName(key);
                if (keyNorm.includes(normalized) || normalized.includes(keyNorm)) {
                    return sku;
                }
            }
            
            return 'UNKNOWN';
        }

        function getVolumeScore(sku) {
            if (MERCHANT_VOLUME_SCORES[sku]) {
                return MERCHANT_VOLUME_SCORES[sku];
            }
            return SKU_DB[sku] || 2;
        }

        function formatScore(num) {
            return Number(num.toFixed(2)).toString();
        }

        async function processPDF(file) {
            showProgress();
            updateProgress(10, 'Membaca PDF...');
            unknownProductsList = [];

            try {
                const arrayBuffer = await file.arrayBuffer();
                
                updateProgress(30, 'Menganalisis orders merchant...');
                const orders = await splitPDFByOrders(arrayBuffer);
                
                if (orders.length === 0) {
                    throw new Error('Tidak ada order yang ditemukan dalam PDF');
                }

                updateProgress(60, 'Mengelompokkan per kardus...');
                const boxGroups = groupOrdersByBox(orders);
                
                updateProgress(90, 'Menyiapkan download...');
                processedOrders = boxGroups;
                
                updateProgress(100, 'Selesai!');
                showResults(boxGroups, orders);
                
            } catch (error) {
                console.error('Error:', error);
                showError('Error memproses PDF: ' + error.message);
                hideProgress();
            }
        }

        async function splitPDFByOrders(arrayBuffer) {
            const { PDFDocument } = PDFLib;
            const pdfDoc = await PDFDocument.load(arrayBuffer);
            const numPages = pdfDoc.getPageCount();
            
            const orders = [];
            let currentOrder = null;
            let currentPages = [];

            const loadingTask = pdfjsLib.getDocument({ data: arrayBuffer });
            const pdf = await loadingTask.promise;

            for (let i = 1; i <= numPages; i++) {
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                const text = textContent.items.map(item => item.str).join(' ');

                // Detect Order ID (barcode text after "Order ID")
                const orderIdMatch = text.match(/Order\s+ID[\s\S]{0,100}?([A-Z0-9]{10,15})\s+Dibuat\s+Pada/i);
                
                // Fallback to Nomor Resi
                const resiMatch = text.match(/Nomor\s+Resi[:\s]*(\d{13,16})/i);
                
                const orderId = orderIdMatch ? orderIdMatch[1] : (resiMatch ? resiMatch[1] : null);
                
                if (orderId && (text.includes('REGULAR') || text.includes('COD:'))) {
                    if (currentOrder && currentPages.length > 0) {
                        const orderPdf = await PDFDocument.create();
                        for (const pageNum of currentPages) {
                            const [copiedPage] = await orderPdf.copyPages(pdfDoc, [pageNum]);
                            orderPdf.addPage(copiedPage);
                        }
                        
                        orders.push({
                            orderId: currentOrder.orderId,
                            resi: currentOrder.resi,
                            items: currentOrder.items,
                            totalScore: currentOrder.totalScore,
                            hasUnknown: currentOrder.hasUnknown,
                            pdf: orderPdf,
                            pdfBytes: await orderPdf.save()
                        });
                    }

                    // Parse ISI PAKET
                    const isiPaketMatch = text.match(/ISI\s+PAKET[:\s]*(.*?)(?=INSTRUKSI|Order\s+ID|$)/is);
                    const items = [];
                    let totalScore = 0;
                    let hasUnknown = false;
                    
                    if (isiPaketMatch) {
                        const content = isiPaketMatch[1];
                        const parts = content.split(',');
                        
                        for (const part of parts) {
                            const qtyMatch = part.match(/(\d+)\s*(pcs|Pcs|PCS)/i);
                            const qty = qtyMatch ? parseInt(qtyMatch[1]) : 1;
                            
                            let productName = part
                                .replace(/\d+\s*(pcs|Pcs|PCS)/gi, '')
                                .trim();
                            
                            if (productName) {
                                const sku = getSKUFromProduct(productName);
                                const volumeScore = getVolumeScore(sku);
                                const itemScore = parseFloat((volumeScore * qty).toFixed(2));
                                
                                if (sku === 'UNKNOWN') {
                                    hasUnknown = true;
                                    if (!unknownProductsList.find(p => p.name === productName)) {
                                        unknownProductsList.push({
                                            name: productName,
                                            count: 1
                                        });
                                    } else {
                                        unknownProductsList.find(p => p.name === productName).count++;
                                    }
                                }
                                
                                items.push({
                                    productName: productName,
                                    sku: sku,
                                    qty: qty,
                                    volumeScore: volumeScore,
                                    itemScore: itemScore
                                });
                                
                                totalScore += itemScore;
                            }
                        }
                    }
                    
                    if (items.length === 0) {
                        items.push({
                            productName: 'Unknown Product',
                            sku: 'UNKNOWN',
                            qty: 1,
                            volumeScore: 2,
                            itemScore: 2
                        });
                        totalScore = 2;
                        hasUnknown = true;
                    }

                    const resiNumber = resiMatch ? resiMatch[1] : '';
                    
                    currentOrder = {
                        orderId: orderId,
                        resi: resiNumber,
                        items: items,
                        totalScore: parseFloat(totalScore.toFixed(2)),
                        hasUnknown: hasUnknown
                    };
                    currentPages = [i - 1];
                } else if (currentOrder) {
                    currentPages.push(i - 1);
                }
            }

            if (currentOrder && currentPages.length > 0) {
                const orderPdf = await PDFDocument.create();
                for (const pageNum of currentPages) {
                    const [copiedPage] = await orderPdf.copyPages(pdfDoc, [pageNum]);
                    orderPdf.addPage(copiedPage);
                }
                
                orders.push({
                    orderId: currentOrder.orderId,
                    resi: currentOrder.resi,
                    items: currentOrder.items,
                    totalScore: currentOrder.totalScore,
                    hasUnknown: currentOrder.hasUnknown,
                    pdf: orderPdf,
                    pdfBytes: await orderPdf.save()
                });
            }

            return orders;
        }

        function chooseBoxSize(totalScore) {
            if (totalScore <= 3) return { type: 'SMALL', capacity: 3, color: '#4CAF50' };
            if (totalScore <= 8) return { type: 'MEDIUM', capacity: 8, color: '#2196F3' };
            if (totalScore <= 20) return { type: 'LARGE', capacity: 20, color: '#FF9800' };
            return { type: 'OVERSIZE', capacity: 100, color: '#F44336' };
        }

        function getSkuPrefix(sku) {
            return sku.replace(/\d+$/, '');
        }

        function groupOrdersByBox(orders) {
            const boxes = {};

            orders.forEach(order => {
                const totalScore = order.totalScore;
                const boxInfo = chooseBoxSize(totalScore);
                const boxType = boxInfo.type;

                if (!boxes[boxType]) {
                    boxes[boxType] = {
                        type: boxType,
                        capacity: boxInfo.capacity,
                        color: boxInfo.color,
                        orders: []
                    };
                }

                boxes[boxType].orders.push(order);
            });

            // Sort by SKU family
            for (const boxType in boxes) {
                boxes[boxType].orders.sort((a, b) => {
                    const skuA = a.items[0].sku;
                    const skuB = b.items[0].sku;
                    
                    const prefixA = getSkuPrefix(skuA);
                    const prefixB = getSkuPrefix(skuB);
                    
                    if (prefixA !== prefixB) {
                        return prefixA.localeCompare(prefixB);
                    }
                    
                    return skuA.localeCompare(skuB);
                });
            }

            return boxes;
        }

        async function downloadBoxPDF(boxType) {
            const { PDFDocument } = PDFLib;
            const boxData = processedOrders[boxType];
            
            const mergedPdf = await PDFDocument.create();
            
            for (const order of boxData.orders) {
                const orderPdf = await PDFDocument.load(order.pdfBytes);
                const copiedPages = await mergedPdf.copyPages(orderPdf, orderPdf.getPageIndices());
                copiedPages.forEach((page) => mergedPdf.addPage(page));
            }
            
            const mergedPdfBytes = await mergedPdf.save();
            const blob = new Blob([mergedPdfBytes], { type: 'application/pdf' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `MERCHANT_KARDUS_${boxType}_${boxData.orders.length}orders_${Date.now()}.pdf`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        async function downloadAllPDF() {
            for (const [boxType, boxData] of Object.entries(processedOrders)) {
                await downloadBoxPDF(boxType);
                await new Promise(resolve => setTimeout(resolve, 500));
            }
        }

        async function downloadSingleOrder(boxType, orderIndex) {
            const order = processedOrders[boxType].orders[orderIndex];
            const blob = new Blob([order.pdfBytes], { type: 'application/pdf' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `MERCHANT_ORDER_${order.orderId}.pdf`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        function showResults(boxGroups, orders) {
            const resultsSection = document.getElementById('resultsSection');
            const boxGroupsDiv = document.getElementById('boxGroups');
            
            document.getElementById('totalOrders').textContent = orders.length;
            document.getElementById('totalBoxes').textContent = Object.keys(boxGroups).length;
            
            let totalItems = 0;
            Object.values(boxGroups).forEach(box => {
                box.orders.forEach(order => {
                    order.items.forEach(item => totalItems += item.qty);
                });
            });
            document.getElementById('totalItems').textContent = totalItems;
            document.getElementById('unknownProducts').textContent = unknownProductsList.length;

            // Show warning if unknown products
            if (unknownProductsList.length > 0) {
                const warningMsg = document.getElementById('warningMessage')
                    warningMsg.innerHTML = `
                    ‚ö†Ô∏è <strong>${unknownProductsList.length} produk tidak dikenali</strong><br>
                    Pastikan nama SKU sudah sesuai atau tambahkan ke <code>MERCHANT_PRODUCT_MAP</code>.
                    <br><br>
                    <strong>Daftar produk tidak dikenali:</strong><br>
                    <ul style="margin-top:10px;">
                        ${unknownProductsList
                            .map(p => `<li>${p.name} <span style="color:#888;">(x${p.count})</span></li>`)
                            .join('')}
                    </ul>
                `;
                warningMsg.style.display = 'block';
            }

            boxGroupsDiv.innerHTML = '';

            // Render box groups
            for (const [boxType, boxData] of Object.entries(boxGroups)) {
                const groupDiv = document.createElement('div');
                groupDiv.classList.add('box-group');

                groupDiv.innerHTML = `
                    <div class="box-header">
                        <span>${boxType} Box</span>
                        <span class="box-badge">${boxData.orders.length} Orders</span>
                    </div>

                    <div class="box-actions">
                        <button class="download-box-btn" onclick="downloadBoxPDF('${boxType}')">
                            üì¶ Download PDF Kardus (${boxType})
                        </button>
                    </div>
                `;

                // Render per-order items
                boxData.orders.forEach((order, index) => {
                    const div = document.createElement('div');
                    div.classList.add('result-item');
                    if (order.hasUnknown) div.classList.add('unknown');

                    const itemList = order.items
                        .map(item => `${item.productName} x${item.qty} <strong>[${item.sku}]</strong>`)
                        .join('<br>');

                    div.innerHTML = `
                        <div class="order-info">
                            <div class="order-id">
                                Order #${order.orderId}
                                <span class="platform-tag">
                                    Merchant
                                </span>

                                <span style="
                                    background:#e3f2fd;
                                    color:#1976d2;
                                    padding:2px 8px;
                                    border-radius:4px;
                                    font-size:11px;
                                    margin-left:8px;
                                    display:inline-block;
                                ">
                                    ${getSkuPrefix(order.items[0].sku)}
                                </span>
                            </div>


                            <div class="order-details">${itemList}</div>
                        </div>

                        <button class="download-btn" onclick="downloadSingleOrder('${boxType}', ${index})">
                            PDF
                        </button>
                    `;

                    groupDiv.appendChild(div);
                });

                boxGroupsDiv.appendChild(groupDiv);
            }

            resultsSection.style.display = 'block';
            hideProgress();
        }

        // UI helpers
        function showProgress() {
            document.getElementById('progressSection').style.display = 'block';
        }

        function hideProgress() {
            document.getElementById('progressSection').style.display = 'none';
        }

        function updateProgress(percent, text) {
            const fill = document.getElementById('progressFill');
            const status = document.getElementById('statusText');
            fill.style.width = percent + '%';
            fill.textContent = percent + '%';
            status.textContent = text;
        }
        function getPlatformClass(platform) {
            if (!platform) return "";
            platform = platform.toLowerCase();

            if (platform.includes("shopee")) return "shopee";
            if (platform.includes("tiktok")) return "tiktok";
            if (platform.includes("tokopedia")) return "tokopedia";

            return "other";
        }

        function showError(msg) {
            const el = document.getElementById('errorMessage');
            el.textContent = msg;
            el.style.display = 'block';
        }

        function hideError() {
            document.getElementById('errorMessage').style.display = 'none';
        }
    </script>
</body>
</html>
